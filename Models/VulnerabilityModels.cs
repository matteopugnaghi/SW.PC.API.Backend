// üõ°Ô∏è Vulnerability Models - EU CRA Compliance
// Models for vulnerability scanning and CVE detection

namespace SW.PC.API.Backend.Models;

/// <summary>
/// Tipos de API de vulnerabilidades soportados
/// </summary>
public enum VulnApiType
{
    OSV,      // Google Open Source Vulnerabilities
    GitHub,   // GitHub Advisory Database
    NVD,      // NIST National Vulnerability Database
    ENISA,    // EU Agency (futuro)
    Custom    // API personalizada
}

/// <summary>
/// Severidad de vulnerabilidad (CVSS)
/// </summary>
public enum VulnSeverity
{
    Unknown,
    Low,      // CVSS 0.1-3.9
    Medium,   // CVSS 4.0-6.9
    High,     // CVSS 7.0-8.9
    Critical  // CVSS 9.0-10.0
}

/// <summary>
/// Vulnerabilidad detectada en una dependencia
/// </summary>
public class Vulnerability
{
    /// <summary>ID √∫nico de la vulnerabilidad (CVE-2024-XXXXX)</summary>
    public string Id { get; set; } = "";
    
    /// <summary>IDs alternativos (GHSA, OSV, etc.)</summary>
    public List<string> Aliases { get; set; } = new();
    
    /// <summary>Resumen corto de la vulnerabilidad</summary>
    public string Summary { get; set; } = "";
    
    /// <summary>Descripci√≥n detallada</summary>
    public string? Details { get; set; }
    
    /// <summary>Severidad (Critical, High, Medium, Low)</summary>
    public VulnSeverity Severity { get; set; } = VulnSeverity.Unknown;
    
    /// <summary>Puntuaci√≥n CVSS (0-10)</summary>
    public double? CvssScore { get; set; }
    
    /// <summary>Paquete/librer√≠a afectada</summary>
    public string AffectedPackage { get; set; } = "";
    
    /// <summary>Versi√≥n instalada (afectada)</summary>
    public string InstalledVersion { get; set; } = "";
    
    /// <summary>Rango de versiones afectadas</summary>
    public string? AffectedVersions { get; set; }
    
    /// <summary>Versi√≥n que corrige la vulnerabilidad</summary>
    public string? FixedVersion { get; set; }
    
    /// <summary>Ecosistema (NuGet, npm, PyPI, etc.)</summary>
    public string Ecosystem { get; set; } = "";
    
    /// <summary>Fecha de publicaci√≥n</summary>
    public DateTime? PublishedDate { get; set; }
    
    /// <summary>Fecha de √∫ltima modificaci√≥n</summary>
    public DateTime? ModifiedDate { get; set; }
    
    /// <summary>URLs de referencia (advisories, patches, etc.)</summary>
    public List<string> References { get; set; } = new();
    
    /// <summary>CWE IDs relacionados</summary>
    public List<string> CweIds { get; set; } = new();
}

/// <summary>
/// Estado del escaneo de vulnerabilidades
/// </summary>
public class VulnerabilityScanStatus
{
    /// <summary>Scanner habilitado (tiene URL configurada)</summary>
    public bool IsEnabled { get; set; }
    
    /// <summary>Tipo de API configurada</summary>
    public string ApiType { get; set; } = "";
    
    /// <summary>URL de la API (parcialmente oculta por seguridad)</summary>
    public string? ApiUrlMasked { get; set; }
    
    /// <summary>√öltimo escaneo exitoso</summary>
    public DateTime? LastScanDate { get; set; }
    
    /// <summary>Pr√≥ximo escaneo programado</summary>
    public DateTime? NextScheduledScan { get; set; }
    
    /// <summary>Intervalo de escaneo en horas (0=manual)</summary>
    public int ScanIntervalHours { get; set; }
    
    /// <summary>Total de paquetes escaneados</summary>
    public int PackagesScanned { get; set; }
    
    /// <summary>Total de vulnerabilidades encontradas</summary>
    public int TotalVulnerabilities { get; set; }
    
    /// <summary>Vulnerabilidades cr√≠ticas</summary>
    public int CriticalCount { get; set; }
    
    /// <summary>Vulnerabilidades altas</summary>
    public int HighCount { get; set; }
    
    /// <summary>Vulnerabilidades medias</summary>
    public int MediumCount { get; set; }
    
    /// <summary>Vulnerabilidades bajas</summary>
    public int LowCount { get; set; }
    
    /// <summary>Estado del √∫ltimo escaneo</summary>
    public string Status { get; set; } = "unknown"; // ok, warning, critical, error, disabled
    
    /// <summary>Mensaje de estado</summary>
    public string? StatusMessage { get; set; }
    
    // Para UI
    public string StatusIcon => Status switch
    {
        "ok" => "‚úÖ",
        "warning" => "‚ö†Ô∏è",
        "critical" => "üî¥",
        "error" => "‚ùå",
        "disabled" => "‚ö´",
        _ => "‚ùì"
    };
    
    public string StatusColor => Status switch
    {
        "ok" => "#4ade80",
        "warning" => "#fbbf24",
        "critical" => "#ef4444",
        "error" => "#f87171",
        "disabled" => "#6b7280",
        _ => "#9ca3af"
    };
}

/// <summary>
/// Resultado de un escaneo de vulnerabilidades
/// </summary>
public class VulnerabilityScanResult
{
    public bool Success { get; set; }
    public string? Message { get; set; }
    public DateTime ScanDate { get; set; } = DateTime.UtcNow;
    public TimeSpan ScanDuration { get; set; }
    
    /// <summary>Paquetes escaneados</summary>
    public int PackagesScanned { get; set; }
    
    /// <summary>Vulnerabilidades encontradas</summary>
    public List<Vulnerability> Vulnerabilities { get; set; } = new();
    
    /// <summary>Errores durante el escaneo</summary>
    public List<string> Errors { get; set; } = new();
    
    /// <summary>Estado resumido</summary>
    public VulnerabilityScanStatus Status { get; set; } = new();
}

/// <summary>
/// Request para consulta OSV (Google Open Source Vulnerabilities)
/// </summary>
public class OsvQueryRequest
{
    public OsvPackage Package { get; set; } = new();
    public string? Version { get; set; }
}

public class OsvPackage
{
    public string Name { get; set; } = "";
    public string Ecosystem { get; set; } = ""; // NuGet, npm, PyPI, etc.
}

/// <summary>
/// Response de OSV API
/// </summary>
public class OsvQueryResponse
{
    public List<OsvVulnerability>? Vulns { get; set; }
}

public class OsvVulnerability
{
    public string? Id { get; set; }
    public string? Summary { get; set; }
    public string? Details { get; set; }
    public List<string>? Aliases { get; set; }
    public DateTime? Published { get; set; }
    public DateTime? Modified { get; set; }
    public List<OsvAffected>? Affected { get; set; }
    public List<OsvReference>? References { get; set; }
    public OsvSeverity? Severity { get; set; }
    public List<OsvSeverityItem>? severity { get; set; } // lowercase for JSON
}

public class OsvAffected
{
    public OsvPackageInfo? Package { get; set; }
    public List<OsvRange>? Ranges { get; set; }
    public List<string>? Versions { get; set; }
}

public class OsvPackageInfo
{
    public string? Name { get; set; }
    public string? Ecosystem { get; set; }
}

public class OsvRange
{
    public string? Type { get; set; }
    public List<OsvEvent>? Events { get; set; }
}

public class OsvEvent
{
    public string? Introduced { get; set; }
    public string? Fixed { get; set; }
}

public class OsvReference
{
    public string? Type { get; set; }
    public string? Url { get; set; }
}

public class OsvSeverity
{
    public string? Type { get; set; }
    public string? Score { get; set; }
}

public class OsvSeverityItem
{
    public string? type { get; set; }
    public string? score { get; set; }
}
